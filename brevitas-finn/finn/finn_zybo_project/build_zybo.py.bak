import finn.builder.build_dataflow as build
import finn.builder.build_dataflow_config as build_cfg

# 1. Point to your exported QONNX file
model_file = "zybo_resnet.onnx"

# 2. Configure the hardware compiler limits
cfg = build_cfg.DataflowBuildConfig(
    output_dir          = "output_hardware",
    
    # CRITICAL FOR ZYBO Z7-10: Keep the target FPS very low (e.g., 10).
    # This forces FINN to "fold" the architecture, reusing the 80 DSPs 
    # instead of trying to unroll the whole network and failing.
    target_fps          = 10,
    synth_clk_period_ns = 10.0, # 100 MHz clock
    
    # Specify the exact board and chip
    board               = "Zybo-Z7-10",
    fpga_part           = "xc7z010clg400-1",
    
    # Tell it to generate a standard Zynq bitstream
    shell_flow_type     = build_cfg.ShellFlowType.VIVADO_ZYNQ,
    
    # We want the actual bitstream and the Python driver for PYNQ
    generate_outputs    = [
        build_cfg.DataflowOutputType.BITFILE,
        build_cfg.DataflowOutputType.PYNQ_DRIVER
    ]
)

# 3. Start the compilation
print("Starting FINN Hardware Build...")
build.build_dataflow_cfg(model_file, cfg)
print("Build Complete!")
