## Overview

This directory contains C code generated by keras2c and then optimized for hardware-friendly execution.
All optimizations are done automatically using `sed`, without manually editing source files.
The main goals are memory alignment, reducing unnecessary initialization, and enabling compiler loop optimizations using GCC pragmas.

---

## my_model.c

This file contains model weights, intermediate buffers, and output arrays generated by keras2c.
Optimizations here focus on memory alignment, storage class changes, and removing redundant initialization.

### Align kernel and bias arrays to 32 bytes

Kernel and bias arrays are aligned to 32 bytes to improve SIMD/vector memory access on modern CPUs.

```
sed -E -i \
's/^float ([a-zA-Z0-9_]*(kernel|bias)_array)\[/float __attribute__((aligned(32))) \1[/' \
my_model.c
```

What this does:

* Matches any `float` array whose name ends with `kernel_array` or `bias_array`
* Adds `__attribute__((aligned(32)))`
* Helps the compiler generate aligned vector loads

---

### Make intermediate buffers static

Certain arrays are used only inside this compilation unit. Marking them `static`:

* Limits symbol visibility
* Allows better compiler optimization
* Reduces relocation overhead

```
sed -E -i \
's/^float ([a-zA-Z0-9_]*(output_array|padded_input_array|dense_fwork))\[/static float \1[/' \
my_model.c
```

Applies to:

* `output_array`
* `padded_input_array`
* `dense_fwork`

---

### Remove zero-initialization that is not required

keras2c sometimes emits arrays like `= {0};`.
These are redundant when the array is fully written before use.

```
sed -E -i 's/=\s*\{0\}\s*;/;/' my_model.c
```

This:

* Removes `{0}` initializers
* Avoids unnecessary `.bss` or `.data` overhead
* Reduces startup cost

---

## include/k2c_convolution_layers.c

This file implements 1D, 2D, and 3D convolution layers.

### Backup original file

```
cp include/k2c_convolution_layers.c include/k2c_convolution_layers.c.bak
```

---

### Add loop vectorization and unrolling for output channels

The innermost loop over output channels is a good target for SIMD and unrolling.

```
sed -E -i '
/void k2c_conv[123]d\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+k[[:space:]]*=[[:space:]]*0;[[:space:]]*k[[:space:]]*<[[:space:]]*out_channels;[[:space:]]*\+\+k[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 4\n&/
}
' include/k2c_convolution_layers.c
```

What this does:

* Targets `k2c_conv1d`, `k2c_conv2d`, and `k2c_conv3d`
* Inserts `#pragma GCC ivdep` to ignore false dependencies
* Unrolls the loop by 4 iterations
* Encourages vectorized execution

---

## include/k2c_helper_functions.c (first pass)

This file contains matrix multiplication and affine operations.

### Backup original file

```
cp include/k2c_helper_functions.c include/k2c_helper_functions.c.bak
```

---

### Optimize affine matrix multiplication (inner dimension loop)

```
sed -E -i '
/void k2c_affine_matmul\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+j[[:space:]]*=[[:space:]]*0;[[:space:]]*j[[:space:]]*<[[:space:]]*innerdim;[[:space:]]*\+\+j[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
}
' include/k2c_helper_functions.c
```

This:

* Targets the accumulation loop
* Uses aggressive unrolling (8)
* Improves throughput in dense layers

---

## include/k2c_helper_functions.c (second pass)

Additional passes further optimize matmul and affine kernels.

### Backup again (overwrites previous backup)

```
cp include/k2c_helper_functions.c include/k2c_helper_functions.c.bak
```

---

### Optimize standard matrix multiplication

```
sed -E -i '
/void k2c_matmul\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+j[[:space:]]*=[[:space:]]*0;[[:space:]]*j[[:space:]]*<[[:space:]]*outcols;[[:space:]]*\+\+j[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
}
' include/k2c_helper_functions.c
```

---

### Further unroll affine matmul inner loops

Applied twice to ensure all matching loops are covered.

```
sed -E -i '
/void k2c_affine_matmul\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+k[[:space:]]*=[[:space:]]*0;[[:space:]]*k[[:space:]]*<[[:space:]]*innerdim;[[:space:]]*\+\+k[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
}
' include/k2c_helper_functions.c
```

```
sed -E -i '
/void k2c_affine_matmul\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+k[[:space:]]*=[[:space:]]*0;[[:space:]]*k[[:space:]]*<[[:space:]]*innerdim;[[:space:]]*\+\+k[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
}
' include/k2c_helper_functions.c
```

Effect:

* Forces aggressive unrolling
* Maximizes ILP in dense computations

---

## include/k2c_merge_layers.c

This file handles merge operations like add, multiply, concatenate.

### Backup original file

```
cp include/k2c_merge_layers.c include/k2c_merge_layers.c.bak
```

---

### Optimize element-wise merge loop

```
sed -E -i '
s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+j[[:space:]]*=[[:space:]]*0;[[:space:]]*j[[:space:]]*<[[:space:]]*output->numel;[[:space:]]*\+\+j[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
' include/k2c_merge_layers.c
```

This:

* Vectorizes element-wise operations
* Improves memory throughput

---

## include/k2c_recurrent_layers.c

This file implements RNN-related logic.

### Backup original file

```
cp include/k2c_recurrent_layers.c include/k2c_recurrent_layers.c.bak
```

---

### Optimize loop over RNN units

```
sed -E -i '
s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+i[[:space:]]*=[[:space:]]*0;[[:space:]]*i[[:space:]]*<[[:space:]]*units;[[:space:]]*\+\+i[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
' include/k2c_recurrent_layers.c
```

This improves:

* State updates
* Activation computation

---

## include/k2c_pooling_layers.c

This file contains max and average pooling implementations.

### Backup original file

```
cp include/k2c_pooling_layers.c include/k2c_pooling_layers.c.bak
```

---

### Optimize global pooling (max and average)

```
sed -E -i '
/void k2c_global_(max|avg)_pooling\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+j[[:space:]]*=[[:space:]]*0;[[:space:]]*j[[:space:]]*<[[:space:]]*in_chan;[[:space:]]*\+\+j[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
}
' include/k2c_pooling_layers.c
```

---

### Optimize 1D max pooling

```
sed -E -i '
/void k2c_maxpool1d\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+l[[:space:]]*=[[:space:]]*0;[[:space:]]*l[[:space:]]*<[[:space:]]*pool_size\*channels;[[:space:]]*l\+=channels[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
}
' include/k2c_pooling_layers.c
```

---

### Optimize 2D max pooling

```
sed -E -i '
/void k2c_maxpool2d\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+p[[:space:]]*=[[:space:]]*0;[[:space:]]*p[[:space:]]*<[[:space:]]*pool_size\[0\]\*channels\*input->shape\[1\];[[:space:]]*p\+=channels\*input->shape\[1\][[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 4\n&/
}
' include/k2c_pooling_layers.c
```

---

### Optimize 1D average pooling

```
sed -E -i '
/void k2c_avgpool1d\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+l[[:space:]]*=[[:space:]]*0;[[:space:]]*l[[:space:]]*<[[:space:]]*pool_size\*channels;[[:space:]]*l\+=channels[[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 8\n&/
}
' include/k2c_pooling_layers.c
```

---

### Optimize 2D average pooling

```
sed -E -i '
/void k2c_avgpool2d\(/,/^}/ {
    s/^[[:space:]]*for[[:space:]]*\([[:space:]]*size_t[[:space:]]+p[[:space:]]*=[[:space:]]*0;[[:space:]]*p[[:space:]]*<[[:space:]]*pool_size\[0\]\*channels\*input->shape\[1\];[[:space:]]*p\+=channels\*input->shape\[1\][[:space:]]*\)/#pragma GCC ivdep\n#pragma GCC unroll 4\n&/
}
' include/k2c_pooling_layers.c
```

---

