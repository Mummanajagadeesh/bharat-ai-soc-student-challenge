`timescale 1ns/1ps
module conv_tb;

    parameter IMG_W = 7;
    parameter IMG_H = 7;

    reg clk, rst;
    reg in_valid;
    reg [7:0] in_pixel;

    reg w_load;
    reg [3:0] w_addr;
    reg [7:0] w_data;

    wire out_valid;
    wire [23:0] out_pixel;

    conv_3x3 #(
        .IMG_W(IMG_W),
        .IMG_H(IMG_H)
    ) dut (
        .clk(clk),
        .rst(rst),

        .in_valid(in_valid),
        .in_pixel(in_pixel),

        .w_load(w_load),
        .w_addr(w_addr),
        .w_data(w_data),

        .out_valid(out_valid),
        .out_pixel(out_pixel)
    );

    always #5 clk = ~clk;

    integer i;

    initial begin
        clk = 0; rst = 1;
        in_valid = 0; in_pixel = 0;
        w_load = 0; w_addr = 0; w_data = 0;

        #20 rst = 0;

        // -----------------------
        // Load kernel from TB (weights 1..9)
        // -----------------------
        for (i=0; i<9; i=i+1) begin
            @(posedge clk);
            w_load <= 1;
            w_addr <= i;
            w_data <= i + 1; // weights: 1..9
        end
        @(posedge clk) begin
            w_load <= 0;
            w_addr <= 0;
            w_data <= 0;
        end

        // -----------------------
        // Send image stream (pixels 1..25 row-major)
        // -----------------------
        for (i=1; i<=IMG_W*IMG_H; i=i+1) begin
            @(posedge clk);
            in_valid <= 1;
            in_pixel <= i;
        end

        @(posedge clk);
        in_valid <= 0;
        in_pixel <= 0;

        // wait for outputs to flush
        repeat(20) @(posedge clk);
        $finish;
    end

    always @(posedge clk) begin
        if (out_valid) begin
            $display("OUT = %0d", out_pixel);
        end
    end

endmodule
